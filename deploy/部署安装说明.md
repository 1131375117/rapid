# 部署安装说明

## docker + docker-compose

项目部署依赖docker和docker-compose环境。

> 版本要求：
>
> docker: 20.10.10 （仅供参考）
>
> docker-compose: 1.29.2 （仅供参考）


## 部署安装包

> 镜像导出命令

```shell script
docker save -o tax-preference-server-0.0.1.tar hai-registry:5000/tax-preference-server:0.0.1
docker save -o tax-preference-web-0.0.1.tar hai-registry:5000/tax-preference-web:0.0.1
docker save -o nginx-1.21.3.tar nginx:1.21.3
docker save -o mysql-5.7.tar mysql:5.7
docker save -o redis-6.2.6.tar redis:6.2.6
docker save -o minio.tar minio/minio
docker save -o elasticsearch-7.15.1.tar docker.elastic.co/elasticsearch/elasticsearch:7.15.1
docker save -o rabbitmq-3-management.tar rabbitmq:3-management
```

|编号|名称|说明|
|---|---|---|
|1.|tax-preference-server-0.0.1.tar|后端服务镜像|
|2.|tax-preference-web-0.0.1.tar|前端前台镜像（nuxt服务端渲染）|
|3.|dist.v.beta.0.0.11.zip|前端后台版本|
|4.|tax-preference.zip|docker-compose启动脚本和配置文件|
|5.|其他docker镜像|其他服务镜像|


### 部署安装步骤

1. 上传所部署安装包；

2. 解压`tax-preference.zip`文件到`/opt/docker/`目录；

3. 配置密码和系统参数

```shell script
cd /opt/docker/tax-preference

# 添加激活环境和各类服务的密码
vim server.env

# 设置 mysql、minio、rabbitmq密码
vim base-server.yml

# 配置redis密码，密码配置项： requirepass foobared
vim redis/redis.conf

```

> base-server.yml修改位置

```yaml
      - "MYSQL_ROOT_PASSWORD=root"
      - "MINIO_ROOT_PASSWORD=hcfAI123456"
      - "RABBITMQ_DEFAULT_PASS=12345678Aa"
```

4. 使用docker加载镜像、启动基础服务并登录到每个服务配置系统项目专用账号

```shell
docker-compose -f base-server.yml up -d
```

```shell script
# mysql
username: tax_preference
password: "自行配置复合安全要求的密码"

# rabbitmq
virtual-host: tax_preference
username: tax_preference
password: "自行配置复合安全要求的密码"

# mimio
bucket: "tax-preference"
access-key: "tax_preference"
secret-key: "自行配置复合安全要求的密码"
```

5. 执行初始化SQL脚本`tax_preference.sql`

6. 创建索引模板和索引

```shell
# 上传 index_template文件夹到服务器，使用执行一下命令创建索引模板和索引，注意修改日期

# 政策
curl -H "Content-Type: application/json" -X PUT -d @policies_index_template.json "http://localhost:9200/_index_template/policies_index_template?pretty"

curl -H "Content-Type: application/json" -X PUT "http://localhost:9200/policies_index_2022-01-04?pretty"

# 政策法规
curl -H "Content-Type: application/json" -X PUT -d @policies_explain_index_template.json "http://localhost:9200/_index_template/policies_explain_index_template?pretty"

curl -H "Content-Type: application/json" -X PUT "http://localhost:9200/policies_explain_index_2022-01-04?pretty"

# 热门问答
curl -H "Content-Type: application/json" -X PUT -d @frequently_asked_question_index_template.json "http://localhost:9200/_index_template/frequently_asked_question_index_template?pretty"

curl -H "Content-Type: application/json" -X PUT "http://localhost:9200/frequently_asked_question_index_2022-01-04?pretty"

# 税收优惠
curl -H "Content-Type: application/json" -X PUT -d @tax_preference_index_template.json "http://localhost:9200/_index_template/tax_preference_index_template?pretty"

curl -H "Content-Type: application/json" -X PUT "http://localhost:9200/tax_preference_index_2022-01-04?pretty"

# 其他文档
curl -H "Content-Type: application/json" -X PUT -d @other_doc_index_template.json "http://localhost:9200/_index_template/other_doc_index_template?pretty"

curl -H "Content-Type: application/json" -X PUT "http://localhost:9200/other_doc_index_2022-01-04?pretty"
```

7. 配置`server.env`文件并启动服务

``````